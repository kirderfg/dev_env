#!/bin/bash
set -e

# Configuration
RESOURCE_GROUP="rg-dev-env"
LOCATION="swedencentral"
VM_NAME="vm-dev"
SSH_KEY_PATH="${HOME}/.ssh/dev_env_key"
SSH_USER="azureuser"
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
INFRA_DIR="${SCRIPT_DIR}/../infra"
ENV_FILE="${SCRIPT_DIR}/../.env"
OP_TOKEN_FILE="${HOME}/.config/dev_env/op_token"

echo "=== Azure Dev VM Deployment ==="

# Check if Azure CLI is installed
if ! command -v az &> /dev/null; then
    echo "Error: Azure CLI is not installed. Install it from https://docs.microsoft.com/en-us/cli/azure/install-azure-cli"
    exit 1
fi

# Check if logged in to Azure
if ! az account show &> /dev/null; then
    echo "Error: Not logged in to Azure. Run 'az login' first."
    exit 1
fi

# Check if VM already exists
echo "Checking for existing VM..."
VM_EXISTS=$(az vm show --resource-group "${RESOURCE_GROUP}" --name "${VM_NAME}" --query "id" -o tsv 2>/dev/null || true)

if [ -n "$VM_EXISTS" ]; then
    echo ""
    echo "WARNING: VM '${VM_NAME}' already exists in resource group '${RESOURCE_GROUP}'."
    echo "Cloud-init configuration cannot be changed on an existing VM."
    echo ""
    read -p "Delete resource group and start fresh? (y/n): " -n 1 -r
    echo ""

    if [[ $REPLY =~ ^[Yy]$ ]]; then
        echo "Deleting resource group ${RESOURCE_GROUP}..."
        az group delete --name "${RESOURCE_GROUP}" --yes --no-wait

        echo "Waiting for deletion to complete..."
        while az group show --name "${RESOURCE_GROUP}" &>/dev/null; do
            echo -n "."
            sleep 5
        done
        echo ""
        echo "Resource group deleted."
    else
        echo "Aborting. To update NSG rules only, use Azure Portal or az CLI directly."
        exit 0
    fi
fi

# Get SSH key - prefer 1Password, fall back to local generation
SSH_FROM_OP=false
if [ -f "$OP_TOKEN_FILE" ] && command -v op &> /dev/null; then
    echo "Fetching SSH key from 1Password..."
    export OP_SERVICE_ACCOUNT_TOKEN="$(cat "$OP_TOKEN_FILE")"

    SSH_PRIVATE=$(op read "op://DEV_CLI/SSH Key/private key" 2>/dev/null || true)
    SSH_PUBLIC=$(op read "op://DEV_CLI/SSH Key/public key" 2>/dev/null || true)

    if [ -n "$SSH_PRIVATE" ] && [ -n "$SSH_PUBLIC" ]; then
        echo "Using SSH key from 1Password"
        mkdir -p "$(dirname "${SSH_KEY_PATH}")"
        echo "$SSH_PRIVATE" > "${SSH_KEY_PATH}"
        echo "$SSH_PUBLIC" > "${SSH_KEY_PATH}.pub"
        chmod 600 "${SSH_KEY_PATH}"
        chmod 644 "${SSH_KEY_PATH}.pub"
        SSH_FROM_OP=true
    else
        echo "SSH key not found in 1Password (op://DEV_CLI/SSH Key)"
    fi
fi

# Fall back to local key generation
if [ "$SSH_FROM_OP" = false ]; then
    if [ ! -f "${SSH_KEY_PATH}" ]; then
        echo "Generating SSH key at ${SSH_KEY_PATH}..."
        ssh-keygen -t ed25519 -f "${SSH_KEY_PATH}" -N "" -C "dev-env-vm"
        echo "SSH key generated."
        echo ""
        echo "TIP: Store this key in 1Password for use from other machines:"
        echo "  Create SSH Key item named 'SSH Key' in vault DEV_CLI"
    fi
fi

# Read SSH public key
SSH_PUBLIC_KEY=$(cat "${SSH_KEY_PATH}.pub")

# Get current public IP for NSG
echo "Getting your public IP..."
MY_IP=$(curl -s ifconfig.me)
echo "Your IP: ${MY_IP}"

# Create resource group if it doesn't exist
echo "Creating resource group ${RESOURCE_GROUP}..."
az group create --name "${RESOURCE_GROUP}" --location "${LOCATION}" --output none

# Deploy infrastructure
echo "Deploying infrastructure..."
az deployment group create \
    --resource-group "${RESOURCE_GROUP}" \
    --template-file "${INFRA_DIR}/main.bicep" \
    --parameters \
        location="swedencentral" \
        namePrefix="dev-env" \
        vmName="${VM_NAME}" \
        vmSize="Standard_D2s_v6" \
        osDiskSizeGB=64 \
        sshPublicKey="${SSH_PUBLIC_KEY}" \
        allowedSshIps="[\"${MY_IP}/32\"]" \
    --output table

# Get public IP
echo ""
echo "=== Deployment Complete ==="
PUBLIC_IP=$(az vm show \
    --resource-group "${RESOURCE_GROUP}" \
    --name "${VM_NAME}" \
    --show-details \
    --query publicIps \
    --output tsv | tr -d '\r')

# Write config to .env file
cat > "${ENV_FILE}" << EOF
# Dev VM Configuration
# Auto-generated by deploy.sh on $(date)

VM_IP=${PUBLIC_IP}
VM_NAME=${VM_NAME}
RESOURCE_GROUP=${RESOURCE_GROUP}
SSH_KEY_PATH=${SSH_KEY_PATH}
SSH_USER=${SSH_USER}
EOF

echo "Config saved to ${ENV_FILE}"
echo ""
echo "Public IP: ${PUBLIC_IP}"
echo "SSH Command: ssh -i ${SSH_KEY_PATH} ${SSH_USER}@${PUBLIC_IP}"
echo ""
echo "Quick connect: ./scripts/ssh-connect.sh"
echo ""

# Wait for cloud-init and check for errors
echo "Waiting for cloud-init to complete..."
ssh-keygen -f "${HOME}/.ssh/known_hosts" -R "${PUBLIC_IP}" 2>/dev/null || true
SSH_CMD="ssh -i ${SSH_KEY_PATH} -o StrictHostKeyChecking=accept-new -o ConnectTimeout=10 ${SSH_USER}@${PUBLIC_IP}"

# Wait for SSH to become available
for i in {1..30}; do
    if $SSH_CMD "exit 0" 2>/dev/null; then
        break
    fi
    echo -n "."
    sleep 5
done
echo ""

# Wait for cloud-init to finish
echo "Waiting for cloud-init..."
$SSH_CMD "cloud-init status --wait" 2>/dev/null || true

# Check for errors
echo ""
echo "=== Cloud-init Status ==="
INIT_ERRORS=$($SSH_CMD "grep -i 'error\|failed\|fatal' /var/log/cloud-init-output.log 2>/dev/null | grep -v 'INFO\|DEBUG' | head -10" 2>/dev/null || true)
INIT_COMPLETE=$($SSH_CMD "cat /var/log/cloud-init-complete.log 2>/dev/null" || true)

if [ -n "$INIT_COMPLETE" ]; then
    echo "Cloud-init: SUCCESS"
else
    echo "Cloud-init: WARNING - setup may not have completed"
    if [ -n "$INIT_ERRORS" ]; then
        echo ""
        echo "Errors found in cloud-init log:"
        echo "$INIT_ERRORS"
    fi
fi

# Sync secrets if available locally
if [ -f "${HOME}/.config/dev_env/op_token" ]; then
    echo ""
    "${SCRIPT_DIR}/sync-secrets.sh" || echo "Warning: Secret sync failed (VM may still be initializing)"

    # Set up git credential helper and clone dev_env repo
    echo ""
    echo "=== Setting up dev_env on VM ==="
    $SSH_CMD bash -s <<'SETUP_EOF'
set -e
export OP_SERVICE_ACCOUNT_TOKEN="$(cat ~/.config/dev_env/op_token 2>/dev/null)"

# Set up git credential helper using gh CLI with PAT from 1Password
GITHUB_PAT=$(op read "op://DEV_CLI/GitHub/PAT" 2>/dev/null || true)
if [ -n "$GITHUB_PAT" ]; then
    echo "$GITHUB_PAT" | gh auth login --with-token
    gh auth setup-git
    echo "✓ GitHub CLI authenticated"
else
    echo "✗ GitHub PAT not found in 1Password - manual gh auth login required"
    exit 1
fi

# Clone dev_env repo if not exists
if [ ! -d ~/dev_env ]; then
    echo "Cloning dev_env repo..."
    git clone https://github.com/kirderfg/dev_env.git ~/dev_env
    echo "✓ dev_env cloned to ~/dev_env"
else
    echo "✓ dev_env already exists at ~/dev_env"
    cd ~/dev_env && git pull --ff-only || true
fi
SETUP_EOF
else
    echo ""
    echo "Warning: No 1Password token found at ~/.config/dev_env/op_token"
    echo "Cannot set up dev_env repo automatically."
fi

echo ""
echo "VM ready! Connect with: ./scripts/ssh-connect.sh"
echo ""
echo "=== DevPod Usage ==="
echo "SSH to VM and run devpods with:"
echo "  ~/dev_env/scripts/dp.sh up https://github.com/user/repo"
echo "  ~/dev_env/scripts/dp.sh list"
